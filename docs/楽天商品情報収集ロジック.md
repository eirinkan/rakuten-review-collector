# 楽天商品ページ 情報収集ロジック レポート

## 検証環境
- **検証日**: 2026-02-20
- **検証方法**: Claude in Chrome で実際のページDOMを調査
- **検証ショップ**:
  1. ロジクール 公式ストア（`logicool/m220gr`） - ブランド公式ショップ
  2. タオル直販店 ヒオリエ／日織恵（`toucher-home/10000264`） - 一般ショップ

---

## 1. ページ構造の概要

楽天市場の商品ページ（`item.rakuten.co.jp`）は**楽天の新UI（CSS moduleクラス）**で構成されている。

- クラス名は `セマンティック名--ハッシュ` 形式（例: `item-price--3L3sy`, `review-score--Ok0fT`）
- ハッシュ部分はビルドごとに変わる可能性があるため、`[class*="セマンティック名--"]` でマッチさせる
- ショップ独自のカスタムHTMLは `.item_desc` 内に格納される

### 検証結果: 2つの異なるショップで同一セレクタが正しく動作することを確認済み

---

## 2. 収集可能な商品情報と抽出方法

### 2.1 商品名

**方法**: `og:title` メタタグから加工

```javascript
function getProductTitle() {
  const ogTitle = document.querySelector('meta[property="og:title"]');
  let title = ogTitle ? ogTitle.content : document.title;
  // 「【楽天市場】」プレフィックスを除去
  title = title.replace(/^【楽天市場】/, '');
  // 「：ショップ名」サフィックスを除去
  title = title.replace(/：[^：]+$/, '');
  return title.trim();
}
```

**検証結果**:
- ロジクール: `【SALE】 ロジクール ワイヤレスマウス M220 無線 マウス 静音...`
- ヒオリエ: `【1枚790円！クーポン＆2枚購入で】 日本製 ホテルスタイルタオル...`

---

### 2.2 販売価格（現在の販売価格）

**方法**: CSS moduleクラスの組み合わせで特定

```javascript
function getSellingPrice() {
  // crimson（赤色）= 販売価格、size-l = メイン表示の大きい価格
  const priceEl = document.querySelector(
    '[class*="number-display--"][class*="color-crimson--"][class*="size-l--"] [class*="number--"][class*="primary--"]'
  );
  if (priceEl) return priceEl.textContent.trim();

  // フォールバック: size-s（小さい表示）
  const priceFallback = document.querySelector(
    '[class*="number-display--"][class*="color-crimson--"][class*="size-s--"] [class*="number--"][class*="primary--"]'
  );
  return priceFallback ? priceFallback.textContent.trim() : '';
}
```

**検証結果**:
- ロジクール: `1,420`（円）
- ヒオリエ: `890`（円）

**注意**: 数値のみ返る（「円」は別の要素）。表示用には `+ '円'` を付与。

---

### 2.3 元価格（メーカー希望小売価格 / 定価）

**方法**: `item-original-price` 内の `value` 要素

```javascript
function getOriginalPrice() {
  const el = document.querySelector(
    '[class*="item-original-price--"] [class*="value--"]'
  );
  return el ? el.textContent.trim() : '';
}
```

**検証結果**:
- ロジクール: `1,650`（メーカー希望小売価格）
- ヒオリエ: `979円`

**注意**: 元価格がない商品では要素自体が存在しない。

---

### 2.4 レビュー評価・件数

```javascript
function getReviewInfo() {
  const scoreEl = document.querySelector('[class*="review-score--"]');
  const totalEl = document.querySelector('[class*="review-total--"]');
  return {
    score: scoreEl ? scoreEl.textContent.trim() : '',
    count: totalEl ? totalEl.textContent.trim().replace(/[()（）]/g, '') : ''
  };
}
```

**検証結果**:
- ロジクール: `{ score: "4.57", count: "1,605件" }`
- ヒオリエ: `{ score: "4.49", count: "115,757件" }`

---

### 2.5 ショップ名

```javascript
function getShopName() {
  // document.titleの最後の「：」以降がショップ名
  const parts = document.title.split('：');
  return parts.length > 1 ? parts[parts.length - 1].trim() : '';
}
```

**検証結果**:
- ロジクール: `ロジクール 公式ストア`
- ヒオリエ: `タオル直販店 ヒオリエ／日織恵`

---

### 2.6 ショップID・商品管理番号（URLから）

```javascript
function getItemIdentifiers() {
  const path = location.pathname;  // /logicool/m220gr/
  const parts = path.split('/').filter(Boolean);
  return {
    shopSlug: parts[0] || '',   // ショップスラッグ
    itemSlug: parts[1] || ''    // 商品管理番号（ショップ内ID）
  };
}
```

**検証結果**:
- ロジクール: `{ shopSlug: "logicool", itemSlug: "m220gr" }`
- ヒオリエ: `{ shopSlug: "toucher-home", itemSlug: "10000264" }`

---

### 2.7 カテゴリ（パンくずリスト）

**方法**: JSON-LD構造化データから取得

```javascript
function getCategories() {
  try {
    const ldScript = document.querySelector('script[type="application/ld+json"]');
    if (!ldScript) return [];
    const data = JSON.parse(ldScript.textContent);
    if (data.itemListElement) {
      return data.itemListElement
        .map(item => item.item?.name || '')
        .filter(name => name && name !== '楽天市場');
    }
  } catch (e) {}
  return [];
}
```

**検証結果**:
- ロジクール: `["パソコン・周辺機器", "マウス・キーボード・入力機器", "マウス"]`
- ヒオリエ: `["日用品雑貨・文房具・手芸", "タオル", "バスタオル"]`

---

### 2.8 バリエーション（SKU選択肢）

```javascript
function getVariations() {
  const buttons = document.querySelectorAll('[class*="button-multiline--"]');
  return Array.from(buttons)
    .map(b => b.textContent.trim().replace(/\s+/g, ' '))
    .filter(text => text.length > 0 && text.length < 50 && text !== '―');
}
```

**検証結果**:
- ロジクール: `["グレー1,420円", "オフホワイト1,420円", "ローズ1,420円"]`
- ヒオリエ: `["オフホワイト／圧縮", "ライトグレー／圧縮", "ウォームグレー／圧縮", ...]`

**注意**: バリエーションボタン内に価格が含まれる場合と含まれない場合がある。

---

### 2.9 商品説明テキスト

```javascript
function getDescription() {
  const desc = document.querySelector('.item_desc');
  if (!desc) return '';
  return desc.textContent.trim();
}
```

**特徴**:
- `.item_desc` はショップのカスタムHTMLが格納されるエリア
- 商品仕様がこの中にテーブル形式で含まれることがある
- 画像も含まれる（ロジクール: 2枚、ヒオリエ: 1枚）
- テキスト量はショップ次第（ロジクール: 809文字、ヒオリエ: 多数）

---

### 2.10 商品画像

```javascript
function getProductImages() {
  const images = [];
  const seen = new Set();

  // 1. og:image（メイン画像）
  const ogImage = document.querySelector('meta[property="og:image"]');
  if (ogImage && ogImage.content) {
    images.push({ url: ogImage.content, type: 'main' });
    seen.add(ogImage.content);
  }

  // 2. 商品画像（rakuten CDN上のショップ画像）
  const shopSlug = location.pathname.split('/').filter(Boolean)[0];
  document.querySelectorAll('img').forEach(img => {
    const src = img.src || '';
    // ショップの商品画像: image.rakuten.co.jp/SHOP/cabinet/...
    if (src.includes(`image.rakuten.co.jp/${shopSlug}/cabinet/`) && img.naturalWidth > 100) {
      if (!seen.has(src)) {
        images.push({ url: src, type: 'product' });
        seen.add(src);
      }
    }
  });

  // 3. item_desc内の画像
  const desc = document.querySelector('.item_desc');
  if (desc) {
    desc.querySelectorAll('img').forEach(img => {
      const src = img.src || '';
      if (src && !src.includes('data:image') && img.naturalWidth > 100 && !seen.has(src)) {
        images.push({ url: src, type: 'description' });
        seen.add(src);
      }
    });
  }

  return images;
}
```

**注意**: 楽天の画像URLパターン: `https://image.rakuten.co.jp/{shopId}/cabinet/{path}.jpg`

---

### 2.11 送料情報

```javascript
function getShippingInfo() {
  // 「送料無料」テキストの有無
  const allElements = document.querySelectorAll('[class*="text-display--"]');
  for (const el of allElements) {
    if (el.textContent.trim() === '送料無料') return '送料無料';
  }

  // フォールバック: テキスト検索
  const freeShip = document.body.innerText.includes('送料無料');
  return freeShip ? '送料無料' : '';
}
```

---

## 3. 統合抽出関数

```javascript
function collectRakutenProductInfo() {
  // 商品名
  const ogTitle = document.querySelector('meta[property="og:title"]');
  let title = ogTitle ? ogTitle.content : document.title;
  title = title.replace(/^【楽天市場】/, '').replace(/：[^：]+$/, '').trim();

  // URLパス
  const pathParts = location.pathname.split('/').filter(Boolean);
  const shopSlug = pathParts[0] || '';
  const itemSlug = pathParts[1] || '';

  // 販売価格
  let sellingPrice = '';
  const priceEl = document.querySelector(
    '[class*="number-display--"][class*="color-crimson--"][class*="size-l--"] [class*="number--"][class*="primary--"]'
  );
  if (priceEl) {
    sellingPrice = priceEl.textContent.trim();
  } else {
    const priceFb = document.querySelector(
      '[class*="number-display--"][class*="color-crimson--"] [class*="number--"][class*="primary--"]'
    );
    if (priceFb) sellingPrice = priceFb.textContent.trim();
  }

  // 元価格
  const origEl = document.querySelector('[class*="item-original-price--"] [class*="value--"]');
  const originalPrice = origEl ? origEl.textContent.trim().replace(/円$/, '') : '';

  // レビュー
  const scoreEl = document.querySelector('[class*="review-score--"]');
  const totalEl = document.querySelector('[class*="review-total--"]');

  // ショップ名
  const titleParts = document.title.split('：');
  const shopName = titleParts.length > 1 ? titleParts[titleParts.length - 1].trim() : '';

  // カテゴリ
  let categories = [];
  try {
    const ldScript = document.querySelector('script[type="application/ld+json"]');
    if (ldScript) {
      const data = JSON.parse(ldScript.textContent);
      if (data.itemListElement) {
        categories = data.itemListElement
          .map(item => item.item?.name || '')
          .filter(name => name && name !== '楽天市場');
      }
    }
  } catch (e) {}

  // バリエーション
  const varButtons = document.querySelectorAll('[class*="button-multiline--"]');
  const variations = Array.from(varButtons)
    .map(b => b.textContent.trim().replace(/\s+/g, ' '))
    .filter(t => t.length > 0 && t.length < 50 && t !== '―');

  // 商品説明
  const descEl = document.querySelector('.item_desc');
  const description = descEl ? descEl.textContent.trim() : '';

  // 画像
  const images = [];
  const seen = new Set();
  const ogImage = document.querySelector('meta[property="og:image"]');
  if (ogImage?.content) {
    images.push({ url: ogImage.content, type: 'main' });
    seen.add(ogImage.content);
  }
  document.querySelectorAll('img').forEach(img => {
    const src = img.src || '';
    if (src.includes(`image.rakuten.co.jp/${shopSlug}/cabinet/`) && img.naturalWidth > 100 && !seen.has(src)) {
      images.push({ url: src, type: 'product' });
      seen.add(src);
    }
  });

  // 送料
  let shipping = '';
  document.querySelectorAll('[class*="text-display--"]').forEach(el => {
    if (el.textContent.trim() === '送料無料') shipping = '送料無料';
  });

  return {
    title,
    shopName,
    shopSlug,
    itemSlug,
    url: location.href.split('?')[0],
    sellingPrice: sellingPrice ? sellingPrice + '円' : '',
    originalPrice: originalPrice ? originalPrice + '円' : '',
    reviewScore: scoreEl ? scoreEl.textContent.trim() : '',
    reviewCount: totalEl ? totalEl.textContent.trim().replace(/[()（）]/g, '') : '',
    categories,
    variations,
    description: description.substring(0, 2000),
    images,
    shipping,
    collectedAt: new Date().toISOString()
  };
}
```

---

## 4. セレクタのフォールバック戦略

CSS moduleクラスのハッシュ部分は変わる可能性がある。以下のフォールバック戦略を推奨:

| 項目 | プライマリ | フォールバック1 | フォールバック2 |
|------|----------|--------------|--------------|
| 商品名 | `og:title` メタタグ | `document.title` | `[class*="price-gap--"] [class*="text-display--"]` |
| 販売価格 | `[class*="color-crimson--"][class*="size-l--"]` 内の `number--` | `[class*="color-crimson--"]` 内の `number--` | テキスト検索で数字+円 |
| 元価格 | `[class*="item-original-price--"]` 内の `value--` | `[class*="original-price--"]` 内の `price-value--` | なし |
| レビュー | `[class*="review-score--"]` | `.normal-reserve-review` テキスト | なし |
| ショップ名 | `document.title` の `：` 以降 | `og:title` の `：` 以降 | URLの `pathParts[0]` |
| カテゴリ | JSON-LD `BreadcrumbList` | なし | なし |
| バリエーション | `[class*="button-multiline--"]` | `[class*="sku-button--"]` | なし |
| 商品説明 | `.item_desc` | `[class*="item-description--"]` | なし |

---

## 5. 既存コードとの比較

### 現在の `content.js` の `getProductInfo()`
- 商品名、URL、追加日時のみ取得（キュー追加用の最小限）
- 価格、レビュー、バリエーション等は未取得

### Amazon の `content-amazon-product.js`
- 20以上のセレクタでフォールバック付き抽出
- A+コンテンツ、技術仕様テーブル、画像ギャラリーも対応
- Google Driveへの保存連携あり

### 楽天版で新規実装が必要な項目
- 販売価格・元価格の抽出
- レビュー情報の抽出
- バリエーションの抽出
- カテゴリの抽出
- 商品画像の収集
- 商品説明テキストの抽出
- ショップ情報の抽出
- 送料情報の抽出

---

## 6. 注意事項

1. **CSS moduleクラスのハッシュ値は変わりうる**: 必ず `[class*="セマンティック名--"]` パターンでマッチさせる
2. **ショップカスタムHTML**: `.item_desc` の中身はショップごとに完全に異なる（テーブル構造、テキスト量、画像数）
3. **specTableArea**: 楽天標準の仕様テーブルエリアだが、中身が空のケースが多い（ショップがitem_descに直接書いている）
4. **バリエーション内の価格**: ボタンテキストに価格が含まれるケース（ロジクール）と含まれないケース（ヒオリエ）がある
5. **og:title の構造**: `【楽天市場】商品名：ショップ名` の形式が安定している
6. **画像の遅延読み込み**: 一部画像は `data-src` 属性で遅延読み込みされるため、ページ読み込み完了後に取得する必要がある
