# レビュー収集 Chrome拡張 - プロジェクトルール

## デプロイルール

バージョンアップ時は以下の手順でデプロイすること：

1. **manifest.jsonのバージョンを更新**
2. **ZIPファイルを作成**
   ```bash
   zip -r レビュー収集_vX.X.X.zip manifest.json popup.html popup.js options.html options.js content.js content-amazon.js background.js icons/ -x "*.DS_Store"
   ```
3. **Trelloカードに添付**
   - カード: https://trello.com/c/hQY7CJMD
   - API経由で添付:
     ```bash
     curl -X POST "https://api.trello.com/1/cards/hQY7CJMD/attachments" \
       -F "key=e0f41be83637fcefd7b041d67b9ba49a" \
       -F "token=ATTA61e53879b0a49029bf89e470749b6370b170e0255d5b8281fff87c59c0f3ad807E2A3474" \
       -F "file=@レビュー収集_vX.X.X.zip" \
       -F "name=レビュー収集_vX.X.X.zip"
     ```
4. **カードの説明欄のバージョン番号を更新**
5. **コメント欄に更新履歴とアップデート手順を追加**（必須）
   ```bash
   curl -X POST "https://api.trello.com/1/cards/hQY7CJMD/actions/comments" \
     -d "key=e0f41be83637fcefd7b041d67b9ba49a" \
     -d "token=ATTA61e53879b0a49029bf89e470749b6370b170e0255d5b8281fff87c59c0f3ad807E2A3474" \
     -d "text=#### vX.X.X 更新内容\n**変更点**\n- 変更点1\n- 変更点2\n\n---\n\n**アップデート手順**\n1. 拡張機能フォルダの場所を確認（初回インストール時に選んだフォルダ）\n2. フォルダの【中身を全て削除】（フォルダ自体は残す）\n3. 新しいZIPの中身をそのフォルダに展開\n4. chrome://extensions で 🔄 ボタンをクリック\n5. 完了（設定・キューは自動引継ぎ）"
   ```
6. **前のバージョンの添付ファイルを削除**
   - 添付一覧を取得:
     ```bash
     curl -s "https://api.trello.com/1/cards/hQY7CJMD/attachments?key=...&token=..." | jq '.[] | {id, name}'
     ```
   - 古いバージョンのZIPを削除:
     ```bash
     curl -X DELETE "https://api.trello.com/1/cards/hQY7CJMD/attachments/{attachment_id}?key=...&token=..."
     ```

## アップデートコメントルール（必須）

**毎回のアップデート時、Trelloコメントには必ず以下を含めること：**

1. **更新内容**（変更点のリスト）
2. **アップデート手順**（以下の定型文を必ず含める）

```
---

**アップデート手順**
1. 拡張機能フォルダの場所を確認（初回インストール時に選んだフォルダ）
2. フォルダの【中身を全て削除】（フォルダ自体は残す）
3. 新しいZIPの中身をそのフォルダに展開
4. chrome://extensions で 🔄 ボタンをクリック
5. 完了（設定・キューは自動引継ぎ）
```

**注意**: アップデート手順は省略不可。ユーザーが誤った方法でアップデートするとデータ損失の可能性があるため。

### 差分検知ルール（必須）

**デプロイ前に必ず前回バージョンとの差分を確認し、変更点を網羅的に記載すること：**

1. **差分の確認方法**
   - 前回のTrelloコメント投稿日時を確認
   - `git log --since="前回投稿日時" --oneline` でコミット一覧を取得
   - `git diff 前回のコミットハッシュ..HEAD --stat` で変更ファイルを確認
   - 各変更ファイルの内容を確認し、ユーザーに影響する変更を特定

2. **記載すべき変更点**
   - 新機能の追加
   - 既存機能の改善・変更
   - バグ修正
   - UI/UXの変更
   - パフォーマンス改善
   - 設定項目の追加・変更

3. **記載の粒度**
   - ユーザーが理解できる言葉で記載（技術用語を避ける）
   - 具体的な動作の変化を説明
   - 設定変更が必要な場合は明記

4. **禁止事項**
   - 差分を確認せずにデプロイコメントを作成しない
   - 変更点を曖昧に記載しない（例：「改善しました」だけはNG）
   - 内部的なリファクタリングのみの記載はNG（ユーザー影響がある変更を優先）

5. **デプロイ前チェックリスト**
   - [ ] 前回デプロイ以降のすべてのコミットを確認したか
   - [ ] 変更されたファイルをすべて確認したか
   - [ ] ユーザーに影響する変更をすべて洗い出したか
   - [ ] 変更点を具体的に記載したか

## ヘルプ更新ルール

機能変更・UI変更時は `options.html` のヘルプセクションを更新すること。

### ヘルプに含める内容
- 基本的な使い方
- **アップデート手順**（上記の定型文を含める）
- トラブルシューティング

### 用語統一
- 「GAS Web App URL」ではなく「ウェブアプリのURL」を使用
- 「リロード」ではなく「更新」を使用

## Trello API情報

**※ APIキー・トークンは `.claude/secrets.md` を参照（Git管理外）**

- **カードID**: hQY7CJMD
- **カードURL**: https://trello.com/c/hQY7CJMD

## Amazon収集 - ボット対策ガイドライン（必須）

**Amazon収集機能を実装・修正する際は、常にボット判定を意識すること。**

### 最重要原則：お前は人間だ

**複雑なロジックを書く前に、まず「人間ならどうするか」を考えろ。**

- ボタンがあれば、シンプルに`element.click()`で押せ
- 人間が見えるものは、そのまま操作すればいい
- 合成イベント（dispatchEvent）のような複雑な処理は避けろ
- 難しく考えすぎるな。人間として振る舞え。

### 「次へ」ボタンの例外（検証済み）

**Amazonの「次へ」リンクは壊れている。** href属性が常に`pageNumber=2`を指しているため、クリックしても正しいページに遷移しない。

**検証結果（2026年1月）：**
- `element.click()` → pageNumber=2に遷移（NG）
- 物理クリック（マウス操作） → pageNumber=2に遷移（NG）
- URL直接操作 → 正しいページに遷移（OK）

**対処法：** 「次へ」ボタンのページ遷移は、URL直接操作（`window.location.href`でページ番号を計算して設定）を使う。これは「人間らしくない」が、Amazonのバグを回避するための唯一の方法。

```javascript
// 「次へ」ボタンの正しい実装
const currentPage = getCurrentPageNumber();
const nextPage = currentPage + 1;
const url = new URL(window.location.href);
url.searchParams.set('pageNumber', nextPage.toString());
window.location.href = url.toString();
```

### 基本原則

1. **人間らしい行動パターンを模倣する**
   - 固定値のタイミングは使わない（必ずランダム化）
   - 「読む」「見渡す」「考える」時間を入れる
   - 機械的な規則性を避ける

2. **Amazonがチェックしているポイント**
   - アクセス間隔の規則性
   - マウス移動パターン（直線移動 = ボット）
   - スクロール動作（一定速度 = ボット）
   - ページ滞在時間
   - セッション中のアクセスパターン

### 実装時の必須事項

| 動作 | NG（ボット的） | OK（人間的） |
|-----|--------------|-------------|
| 待機時間 | 固定3秒 | 指数分布（平均1.5秒、最大8秒） |
| スクロール | 一定速度 | 加速・減速パターン、途中停止 |
| マウス移動 | 直線移動 | ベジェ曲線、微小ブレ |
| ページ遷移 | 即座に次へ | 「読む」時間を挟む |
| 連続アクセス | 無制限 | レート制限（100ページ/日） |
| 同時実行 | 複数タブ | 1件ずつ（同時1件） |

### タイミング設計（参考値）

```javascript
// ページ遷移前の待機（指数分布）
const waitTime = Math.min(exponentialRandom(1500), 8000); // 平均1.5秒、最大8秒

// レビュー読む時間（文字数に応じて）
const readTime = (charCount / 100) * 400; // 100文字あたり0.4秒

// マイクロブレイク（5%の確率で発生）
if (Math.random() < 0.05) { ... }
```

### 禁止事項

- **固定値のsetTimeout/setIntervalを使わない**
- **直線的なマウス移動を使わない**
- **一定速度のスクロールを使わない**
- **URLパラメータの一括変更をしない**（ページ番号以外）
- **複数タブでの同時収集をしない**

### セレクタのフォールバック

Amazonのページ構造は変わることがあるため、セレクタは複数用意し、見つからない場合のフォールバックを実装すること。

```javascript
// 例: 次へボタンのセレクタ
const nextSelectors = [
  'li.a-last a',                  // 標準
  '.a-pagination li.a-last a',    // ページネーション内
  '.a-pagination a:last-child',   // 最後のリンク
];
```

### チェックリスト（Amazon関連の修正時）

- [ ] 待機時間はランダム化されているか
- [ ] マウス移動はベジェ曲線か
- [ ] スクロールは加速・減速パターンか
- [ ] レート制限は守られているか
- [ ] 同時実行は1件に制限されているか
- [ ] セレクタのフォールバックはあるか
